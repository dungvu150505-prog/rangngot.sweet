<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gá»­i lá»i chÃºc - RÄƒng Ngá»t</title>

  <!-- CSS chÃ­nh -->
  <link rel="stylesheet" href="/style.css">
  <!-- EB Garamond -->
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- Bá»• sung fix nhá» (font Ä‘á»“ng bá»™ + tim bay + cÄƒn QR + progress bar) -->
  <style>
    /* Äá»“ng bá»™ font cho má»i control & text */
    html, body, button, input, textarea, select, a, p, h1, h2, h3, h4, h5 {
      font-family: 'EB Garamond', serif !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    button, input[type="button"], input[type="submit"] { -webkit-appearance: none; appearance: none; }
    .play, .btn-secondary { font-family: inherit !important; font-weight: 600; letter-spacing: .2px; }

    .actions { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }
    .small-note { font-size:.9rem; color:#888; margin-top:8px; }
    .rec-box { background:#fff5f9; border-radius:14px; margin-top:16px; padding:14px; box-shadow: inset 0 0 6px rgba(255,150,180,.15); }
    .rec-row { margin-top:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .rec-timer { margin-left:8px; min-width:48px; display:inline-block; }
    #qrCanvas { margin:12px auto 0; display:flex; justify-content:center; }
    .qr-actions { margin-top:8px; display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }

    /* Progress bar */
    .progress {
      margin: 10px auto 0;
      width: 220px;
      height: 8px;
      background: #ffe0ec;
      border-radius: 99px;
      overflow: hidden;
      display: none;
    }
    .progress > span {
      display:block; height:100%; width:0%;
      background:#ff93b8; transition: width .2s ease;
    }

    /* TrÃ¡i tim bay tá»« dÆ°á»›i mÃ n hÃ¬nh */
    .heart{
      position:fixed; bottom:-20px; width:18px; height:18px;
      background:#fba4c2; transform:rotate(45deg); animation:flyUp 6s linear infinite; z-index:0;
    }
    .heart::before,.heart::after{
      content:""; position:absolute; width:18px; height:18px; background:#fba4c2; border-radius:50%;
    }
    .heart::before{ top:-9px; left:0; }
    .heart::after{ top:0; left:-9px; }
    @keyframes flyUp{
      0%{ transform:translateY(0) rotate(45deg); opacity:1; }
      100%{ transform:translateY(-100vh) rotate(45deg); opacity:0; }
    }
  </style>
</head>

<body>
  <!-- ğŸ° Logo + slogan -->
  <img src="https://file.garden/aO0lFjCQS03opF7T/st.PNG" alt="Logo RangNgot" class="logo">
  <div class="slogan">From RangNgot with Love ğŸ’</div>

  <!-- ğŸ€ Thiá»‡p chÃ­nh -->
  <div class="card">
    <h1>Gá»­i chÃºt ngá»t ngÃ o Ä‘áº¿n ngÆ°á»i báº¡n thÆ°Æ¡ng ğŸ’Œ</h1>
    <p>HÃ£y nÃ³i lá»i yÃªu thÆ°Æ¡ng cá»§a báº¡n, chÃºng mÃ¬nh sáº½ gÃ³i láº¡i tháº­t xinh vÃ  gá»­i tá»›i ngÆ°á»i Ä‘áº·c biá»‡t dá»‹p 20/10 ğŸ’–</p>

    <!-- CHO PHÃ‰P: áº£nh + audio + video -->
    <input type="file" id="filePicker" accept="image/*,audio/*,video/*" hidden />
    <div class="actions">
      <!-- (1) Äá»•i nhÃ£n nÃºt upload -->
      <button id="btnPick" class="play">Upload (áº£nh/audio/video)</button>
      <!-- (2) Äá»•i nhÃ£n nÃºt ghi Ã¢m -->
      <button id="btnRecord" class="btn-secondary">ğŸ° Gá»­i lá»i yÃªu thÆ°Æ¡ng</button>
    </div>
    <div class="small-note">
      iPhone: náº¿u khÃ´ng tháº¥y file trong â€œáº¢nhâ€, hÃ£y chá»n â€œTá»‡pâ€ (Files) hoáº·c dÃ¹ng nÃºt <b>Ghi Ã¢m trá»±c tiáº¿p</b>.<br>
      <b>KÃ­ch thÆ°á»›c tá»‘i Ä‘a ~25MB</b>
    </div>

    <!-- Khu Ä‘iá»u khiá»ƒn ghi Ã¢m -->
    <div id="recPanel" class="rec-box" style="display:none;">
      <div id="recStatus">Sáºµn sÃ ng ghi Ã¢m báº±ng micro thiáº¿t bá»‹.</div>
      <div class="rec-row">
        <button id="btnStartRec" class="btn-secondary">â–¶ï¸ Báº¯t Ä‘áº§u</button>
        <button id="btnStopRec" class="btn-secondary" disabled>â¹ Dá»«ng & gá»­i</button>
        <span id="recTimer" class="rec-timer">00:00</span>
      </div>
      <audio id="recPreview" controls style="margin-top:10px; display:none; width:100%;"></audio>
    </div>

    <!-- Káº¿t quáº£ -->
    <div id="result" class="result-box" style="display:none;">
      <p>âœ¨ Link ngÆ°á»i nháº­n cá»§a báº¡n:</p>
      <a id="receiverLink" target="_blank" rel="noopener"></a>
      <div id="qrCanvas"></div>
      <div class="progress" id="progress"><span id="bar"></span></div>
      <div class="qr-actions">
        <button id="btnDownloadQR" class="btn-secondary">â¬‡ï¸ Táº£i QR</button>
        <button id="btnCopyLink" class="btn-secondary">ğŸ”— Copy link</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.API_BASE || '';

    // ====== CONST ======
    const MAX_SIZE_MB = 25; // an toÃ n dÆ°á»›i giá»›i háº¡n server
    const ACCEPTED_PREFIX = ['image/','audio/','video/'];

    // DOM
    const picker = document.getElementById('filePicker');
    const btnPick = document.getElementById('btnPick');

    const btnRecord   = document.getElementById('btnRecord');
    const recPanel    = document.getElementById('recPanel');
    const btnStartRec = document.getElementById('btnStartRec');
    const btnStopRec  = document.getElementById('btnStopRec');
    const recStatus   = document.getElementById('recStatus');
    const recTimer    = document.getElementById('recTimer');
    const recPreview  = document.getElementById('recPreview');

    const resultBox   = document.getElementById('result');
    const receiverLink= document.getElementById('receiverLink');
    const qrCanvas    = document.getElementById('qrCanvas');
    const btnDownloadQR = document.getElementById('btnDownloadQR');
    const btnCopyLink = document.getElementById('btnCopyLink');

    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');

    // (3) Äá»“ng bá»™ cá»¡ chá»¯ nÃºt ghi Ã¢m = nÃºt upload (chá»‰ Ã¡p dá»¥ng #btnRecord)
    requestAnimationFrame(() => {
      const fs = getComputedStyle(btnPick).fontSize;
      if (fs) btnRecord.style.fontSize = fs;
    });

    // State ghi Ã¢m
    let mediaStream, mediaRecorder, recChunks = [], recInterval, recSeconds = 0;

    // ===== Upload file =====
    btnPick.addEventListener('click', () => picker.click());
    picker.addEventListener('change', async () => {
      if (!picker.files.length) return;
      const file = picker.files[0];

      // Kiá»ƒm tra loáº¡i file
      const type = file.type || '';
      const isAccepted = ACCEPTED_PREFIX.some(p => type.startsWith(p));
      if (!isAccepted) {
        alert('HÃ£y chá»n áº£nh, Ã¢m thanh hoáº·c video nhÃ©.');
        picker.value = '';
        return;
      }

      // Kiá»ƒm tra kÃ­ch thÆ°á»›c
      const sizeMB = file.size / (1024*1024);
      if (sizeMB > MAX_SIZE_MB) {
        alert(`File quÃ¡ lá»›n (${sizeMB.toFixed(1)}MB). Giá»›i háº¡n hiá»‡n táº¡i lÃ  ${MAX_SIZE_MB}MB.`);
        picker.value = '';
        return;
      }

      await uploadFile(file);
      picker.value = ''; // reset Ä‘á»ƒ chá»n láº¡i Ä‘Æ°á»£c
    });

    // ===== Panel ghi Ã¢m =====
    btnRecord.addEventListener('click', () => {
      recPanel.style.display = 'block';
      if (!navigator.mediaDevices?.getUserMedia) {
        recStatus.textContent = 'TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ ghi Ã¢m. Vui lÃ²ng táº£i file thay tháº¿.';
        btnStartRec.disabled = true;
      } else {
        recStatus.textContent = 'Sáºµn sÃ ng ghi Ã¢m báº±ng micro thiáº¿t bá»‹.';
      }
    });

    // Báº¯t Ä‘áº§u ghi
    btnStartRec.addEventListener('click', async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const mimeCandidates = ['audio/webm', 'audio/mp4', 'audio/ogg'];
        let mimeType = '';
        for (const m of mimeCandidates) {
          if (window.MediaRecorder && MediaRecorder.isTypeSupported?.(m)) { mimeType = m; break; }
        }

        mediaRecorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);
        recChunks = [];
        mediaRecorder.ondataavailable = e => e.data?.size && recChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(recChunks, { type: mimeType || 'audio/webm' });
          recPreview.src = URL.createObjectURL(blob);
          recPreview.style.display = 'block';

          const ext = (mimeType.includes?.('mp4')) ? 'm4a'
                    : (mimeType.includes?.('ogg')) ? 'ogg'
                    : 'webm';
          const file = new File([blob], `voice-${Date.now()}.${ext}`, { type: blob.type });

          // Kiá»ƒm tra size trÆ°á»›c khi gá»­i
          const sizeMB = file.size / (1024*1024);
          if (sizeMB > MAX_SIZE_MB) {
            alert(`Báº£n ghi quÃ¡ lá»›n (${sizeMB.toFixed(1)}MB). Giá»›i háº¡n hiá»‡n táº¡i lÃ  ${MAX_SIZE_MB}MB.`);
          } else {
            await uploadFile(file);
          }
          cleanupRecording();
        };

        mediaRecorder.start();
        recStatus.textContent = 'Äang ghiâ€¦';
        btnStartRec.disabled = true;
        btnStopRec.disabled  = false;

        // Äá»“ng há»“
        recSeconds = 0;
        recTimer.textContent = '00:00';
        recInterval = setInterval(() => {
          recSeconds++;
          const mm = String(Math.floor(recSeconds/60)).padStart(2,'0');
          const ss = String(recSeconds%60).padStart(2,'0');
          recTimer.textContent = `${mm}:${ss}`;
        }, 1000);

      } catch (e) {
        console.error(e);
        recStatus.textContent = 'KhÃ´ng truy cáº­p Ä‘Æ°á»£c micro. HÃ£y cáº¥p quyá»n hoáº·c dÃ¹ng cÃ¡ch táº£i file.';
      }
    });

    // Dá»«ng & gá»­i
    btnStopRec.addEventListener('click', () => {
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
      } catch {}
      clearInterval(recInterval);
      btnStopRec.disabled = true;
      recStatus.textContent = 'Äang xá»­ lÃ½â€¦';
    });

    function cleanupRecording() {
      try { mediaStream && mediaStream.getTracks().forEach(t => t.stop()); } catch {}
      clearInterval(recInterval);
      recStatus.textContent = 'ÄÃ£ gá»­i xong.';
      btnStartRec.disabled = false;
      btnStopRec.disabled  = true;
    }

    // ===== Upload dÃ¹ng chung (cÃ³ progress) =====
    async function uploadFile(file) {
      btnPick.disabled = true;
      btnRecord.disabled = true;
      const oldText = btnPick.textContent;
      btnPick.textContent = 'Äang gá»­i yÃªu thÆ°Æ¡ngâ€¦';

      // Hiá»‡n progress
      progress.style.display = 'block';
      bar.style.width = '0%';

      // DÃ¹ng XMLHttpRequest Ä‘á»ƒ theo dÃµi tiáº¿n trÃ¬nh
      const formData = new FormData();
      formData.append('audio', file); // server Ä‘á»c field 'audio'

      try {
        const url = `${API_BASE}/upload`;
        const response = await xhrUpload(url, formData, (percent) => {
          bar.style.width = percent + '%';
        });

        const data = JSON.parse(response);
        if (!data.success) throw new Error(data.message || 'Upload tháº¥t báº¡i');

        const fullURL = data.absoluteReceiverUrl || `${location.origin}${data.receiverUrl}`;
        receiverLink.textContent = fullURL;
        receiverLink.href = fullURL;

        // Táº¡o QR (cá»¡ lá»›n, cÄƒn giá»¯a)
        qrCanvas.innerHTML = '';
        new QRCode(qrCanvas, { text: fullURL, width: 200, height: 200, colorDark: '#e2528e', colorLight: '#fff7fa' });
        resultBox.style.display = 'block';
        resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        console.error(err);
        alert('CÃ³ lá»—i khi gá»­i lÃªn mÃ¡y chá»§. Thá»­ láº¡i nhÃ©!');
      } finally {
        btnPick.disabled = false;
        btnRecord.disabled = false;
        btnPick.textContent = oldText;
        setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 600);
      }
    }

    // Helper: upload báº±ng XHR Ä‘á»ƒ cÃ³ progress
    function xhrUpload(url, formData, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.upload.onprogress = (e) => {
          if (!e.lengthComputable) return;
          const percent = Math.min(100, Math.round((e.loaded / e.total) * 100));
          onProgress?.(percent);
        };
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve(xhr.responseText) : reject(new Error(xhr.statusText || 'Upload error'));
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
      });
    }

    // Táº£i QR vá» mÃ¡y
    btnDownloadQR.addEventListener('click', () => {
      const cvs = qrCanvas.querySelector('canvas');
      const img = qrCanvas.querySelector('img');
      let dataURL = cvs?.toDataURL?.('image/png') || img?.src || '';
      if (!dataURL) return alert('KhÃ´ng tÃ¬m tháº¥y QR Ä‘á»ƒ táº£i.');
      const a = document.createElement('a');
      a.href = dataURL; a.download = 'qr-rangngot.png';
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Copy link
    btnCopyLink.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(receiverLink.href);
        btnCopyLink.textContent = 'âœ… ÄÃ£ copy';
        setTimeout(() => btnCopyLink.textContent = 'ğŸ”— Copy link', 1500);
      } catch {
        alert('Copy tháº¥t báº¡i, báº¡n hÃ£y copy thá»§ cÃ´ng nhÃ©.');
      }
    });

    // ğŸ’— Tim bay ngáº«u nhiÃªn
    setInterval(() => {
      const heart = document.createElement('div');
      heart.classList.add('heart');
      heart.style.left = Math.random() * 100 + 'vw';
      heart.style.animationDuration = (4 + Math.random() * 3) + 's';
      heart.style.backgroundColor = `hsl(${340 + Math.random() * 20}, 90%, 75%)`;
      document.body.appendChild(heart);
      setTimeout(() => heart.remove(), 7000);
    }, 900);
  </script>
</body>
</html>
